# VigilCD - GitOps Deployment Agent

**VigilCD** is a lightweight GitOps deployment agent that automatically monitors Git repositories and performs Docker Compose deployments on changes. Built for self-hosted environments with support for private repositories and Docker registries.

[![Python 3.14](https://img.shields.io/badge/python-3.14-blue.svg)](https://www.python.org/downloads/)
[![CI Status](https://github.com/ruben-sprengel/vigil-cd/actions/workflows/vigilcd-ci.yml/badge.svg)](https://github.com/ruben-sprengel/vigil-cd/actions)
![Image Build Status](https://github.com/ruben-sprengel/vigil-cd/actions/workflows/vigilcd-image-build.yml/badge.svg)
[![Code Style: Ruff](https://img.shields.io/badge/code%20style-ruff-%23000000.svg)](https://github.com/astral-sh/ruff)
[![Linting: Ruff](https://img.shields.io/badge/linting-ruff-%23000000.svg)](https://github.com/astral-sh/ruff)
[![Dependency Manager: uv](https://img.shields.io/badge/dependency%20manager-uv-%23000000.svg)](https://astral.sh/uv)


[![ko-fi](https://ko-fi.com/img/githubbutton_sm.svg)](https://ko-fi.com/rubensprengel)

## ğŸ¯ Features

- âœ… **Automatic Git Sync** - Periodic polling or webhook-based
- âœ… **Parallel Processing** - Independent jobs per repo/branch for maximum performance
- âœ… **Multi-Repository** - Manage multiple repos and branches simultaneously
- âœ… **SSH & HTTPS Auth** - Private GitHub/GitLab repositories
- âœ… **Private Registries** - GHCR, Docker Hub, self-hosted with secure credential cleanup
- âœ… **Health Checks** - Auto-recovery on failures
- âœ… **RESTful API** - Status monitoring and manual triggers
- âœ… **Flexible Timeouts** - Configurable timeouts with float precision or disable entirely
- âœ… **Secure** - Non-root container (UID 1000) + guaranteed credential cleanup
- âœ… **Multi-Arch** - AMD64 and ARM64 (Raspberry Pi)

## ğŸš€ Quick Start

### Prerequisites

- Docker
- Docker Compose
- UV

### Installation

```bash
# 1. Clone repository
git clone https://github.com/ruben-sprengel/vigil-cd.git
cd vigil-cd

# 2. Run setup (auto-configures everything)
chmod +x setup.sh
./setup.sh

# 3. Edit configuration
vim config/config.yaml  # Add your repositories

# 4. Add secrets
vim .env  # Add authentication tokens

# 5. Start VigilCD
docker-compose up -d

# 6. Verify
curl http://localhost:8000/health
```

**That's it!** VigilCD is now monitoring your repositories.

## âš™ï¸ Configuration

### What `setup.sh` Does

The setup script automatically:
- âœ… Creates `config.yaml` from template
- âœ… **Auto-detects Docker socket GID** (required for deployments)
- âœ… Generates `.env` with correct permissions
- âœ… Sets up directories (`repos/`, `ssh-keys/`, `logs/`)
- âœ… (Optional) Generates SSH keys for private repos
- âœ… Validates configuration

### Repository Configuration

Edit `config/config.yaml`:

```yaml
repos:
  # Public HTTPS repository
  - name: "my-app"
    url: "https://github.com/username/my-app"
    auth_method: "https"
    branches:
      - name: "main"
        targets:
          - name: "app"
            file: "docker-compose.yml"
            deploy: true
            build_images: false

  # Private SSH repository
  - name: "private-app"
    url: "git@github.com:username/private-app.git"
    auth_method: "ssh"
    branches:
      - name: "production"
        targets:
          - name: "api"
            file: "docker-compose.yml"
            deploy: true
            build_images: true

  # With private Docker registry
  - name: "microservice"
    url: "git@github.com:company/microservice.git"
    auth_method: "ssh"
    registries:
      - url: "ghcr.io"
        username: "bot"
        password_env_var: "GHCR_TOKEN"
    branches:
      - name: "main"
        targets:
          - name: "service"
            file: "docker-compose.yml"
            deploy: true
```

### Environment Variables

Edit `.env` (auto-generated by `setup.sh`):

```bash
# Docker Configuration (auto-detected)
DOCKER_GID=999

# Git Authentication
VIGILCD_GITHUB_TOKEN=ghp_xxxxx

# Docker Registry Authentication
GHCR_TOKEN=ghp_xxxxx

# Scheduling (optional)
VIGILCD_CHECK_INTERVAL_MINUTES=5
VIGILCD_LOG_LEVEL=INFO
```

## ğŸ” SSH Keys for Private Repos

### Automatic Setup

The `setup.sh` script prompts you to generate SSH keys. Alternatively:

```bash
# Generate key
ssh-keygen -t ed25519 -C "vigilcd-test" -f id_ed25519_vigilcd

# Show public key
cat ./ssh-keys/id_ed25519_vigilcd.pub

# Add to GitHub:
# Repository â†’ Settings â†’ Deploy Keys â†’ Add deploy key
```

### Multiple Keys

For different repos with different keys:

```yaml
repos:
  - name: "service-a"
    url: "git@github.com:company/service-a.git"
    auth_method: "ssh"
    ssh_key_path: "/home/vigilcd/.ssh/service_a_key"
```

## ğŸ³ Private Docker Registries

### Configuration

1. **Add token to `.env`:**

```bash
GHCR_TOKEN=ghp_xxxxx
```

2. **Configure in `config.yaml`:**

```yaml
repos:
  - name: "my-app"
    registries:
      - url: "ghcr.io"
        username: "deployment-bot"
        password_env_var: "GHCR_TOKEN"
```

### Supported Registries

- GitHub Container Registry (ghcr.io)
- Docker Hub (docker.io)
- Self-hosted registries
- AWS ECR, GCR, etc.

## ğŸ“¡ API Endpoints

Check out the interactive swagger docs here:

```
http://localhost:8000/docs
```

## ğŸ—ï¸ Architecture

```
VigilCD Container (vigilcd user)
â”œâ”€â”€ FastAPI (Web API)
â”œâ”€â”€ APScheduler (Periodic checks)
â”œâ”€â”€ GitPython (Git operations)
â””â”€â”€ DeploymentService
    â”œâ”€â”€ Git sync (fetch + reset --hard)
    â”œâ”€â”€ Docker Compose deployment
    â””â”€â”€ Health checks
```

### How It Works

1. **Scheduler** triggers sync check every N minutes
2. **Git Check** fetches remote commit hash
3. **Comparison** with local commit
4. **Update** if different: `git fetch` + `git reset --hard`
5. **Deploy** via `docker compose up -d`
6. **Health Check** monitors container status
7. **Recovery** redeploys failed containers

## ğŸ› Troubleshooting

### Permission Issues

```bash
./fix-permissions.sh
docker-compose restart vigilcd
```

### Docker Socket Access

```bash
# Verify DOCKER_GID in .env
cat .env | grep DOCKER_GID

# Re-run setup if changed
./setup.sh
```

### SSH Authentication Failed

```bash
# Check key permissions
ls -la ./ssh-keys/

# Test connection
docker exec vigilcd ssh -T git@github.com
```

### Config Changes Not Applied

```bash
docker-compose restart vigilcd
docker-compose logs vigilcd
```

### View Logs

```bash
# Follow logs
docker-compose logs -f vigilcd

# Last 100 lines
docker-compose logs --tail=100 vigilcd

# Search for errors
docker-compose logs vigilcd | grep -i error
```

## ğŸ”’ Security

### Files in Git âœ…

```
âœ… config/config.template.yaml
âœ… .env.template
âœ… docker-compose.yml
âœ… Dockerfile
âœ… setup.sh
```

### Never Commit âŒ

```
âŒ config/config.yaml (repo-specific)
âŒ .env (secrets!)
âŒ ssh-keys/ (private keys!)
âŒ repos/ (cloned repos)
```

### Best Practices

- âœ… Use **Deploy Keys** (not personal tokens)
- âœ… Rotate credentials every 90 days
- âœ… Limit token scopes (`read:packages` only)
- âœ… Run container as non-root (UID 1000)
- âœ… Use HTTPS for webhooks (reverse proxy)

## ğŸ”„ Updating

### Configuration Changes

```bash
vim config/config.yaml
docker-compose restart vigilcd
```

### Update Image

```bash
docker-compose pull
docker-compose up -d
```

### Add New Repository

1. Edit `config/config.yaml`
2. Restart: `docker-compose restart vigilcd`
3. Verify: `curl http://localhost:8000/api/status`

## ğŸ›ï¸ Advanced Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DOCKER_GID` | Auto-detected | Docker socket group (required) |
| `VIGILCD_CHECK_INTERVAL_MINUTES` | `5` | Polling interval |
| `VIGILCD_GIT_RETRY_COUNT` | `3` | Git operation retries |
| `VIGILCD_DOCKER_TIMEOUT` | `300` | Docker Compose timeout (seconds) |
| `VIGILCD_LOG_LEVEL` | `INFO` | Log level (DEBUG, INFO, WARNING, ERROR) |

### Repository Options

| Field | Required | Description |
|-------|----------|-------------|
| `name` | âœ… | Unique identifier |
| `url` | âœ… | Git URL (HTTPS or SSH) |
| `auth_method` | âŒ | `"https"` or `"ssh"` (default: `"https"`) |
| `ssh_key_path` | âŒ | Custom SSH key path |
| `registries` | âŒ | Private Docker registries |

### Target Options

| Field | Default | Description |
|-------|---------|-------------|
| `deploy` | `true` | Auto-deploy on changes |
| `build_images` | `false` | Run `docker compose up --build` |

## ğŸ“Š Production Deployment

### Resource Limits

```yaml
# docker-compose.yml
deploy:
  resources:
    limits:
      cpus: '1.0'
      memory: 512M
```

### Logging

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### Monitoring

- Health endpoint: `/health`
- Status endpoint: `/api/status`
- Metrics: (Coming soon)

### Backup

```bash
tar -czf vigilcd-backup.tar.gz config/ .env ssh-keys/
```

## ğŸ¤ Contributing

Contributions welcome! Please:

1. Fork the repository
2. Create feature branch
3. Submit pull request

### Development Setup

```bash
pip install uv
uv sync --extra dev
uv run uvicorn src.app:app --reload
```

## ğŸ“ License

MIT License - see [LICENSE](LICENSE) file

## ğŸ™ Acknowledgments

Built with:
- [FastAPI](https://fastapi.tiangolo.com/)
- [GitPython](https://gitpython.readthedocs.io/)
- [APScheduler](https://apscheduler.readthedocs.io/)
- [uv](https://github.com/astral-sh/uv)

## ğŸ“® Support

- **Issues:** [GitHub Issues](https://github.com/ruben-sprengel/vigil-cd/issues)
- **Documentation:** This README
- **Sponsor:** [Ko-fi](https://ko-fi.com/rubensprengel)
